<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æª”æ¡ˆé‡å‘½åå·¥å…·</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body {
            background-color: #f5f5f5;
        }
        .container {
            margin-top: 50px;
        }
        .footer {
            margin-top: 50px;
            text-align: center;
            font-size: 14px;
            color: #777;
        }
    </style>
</head>
<body>
    <div class="container">
        <h3 class="text-center mb-4">ğŸ“ æƒææª”é‡æ–°å‘½åå·¥å…·</h3>
        <!-- ä½¿ç”¨èªªæ˜å€å¡Š -->
        <div class="card p-4 mb-4">
            <h5>ğŸ’¡ä½¿ç”¨èªªæ˜</h5>
            <ul>
                <li>æœ¬å·¥å…·åƒ…æ”¯æ´ Ragic ä¸‹è¼‰é™„ä»¶</li>
                <li>è‡³ Ragic å®¢æˆ¶åˆç´„ç®¡ç† â†’ å·¥å…· â†’ ä¸‹è¼‰é™„ä»¶ â†’ å…¨éƒ¨è³‡æ–™ â†’ å¾æ­¤æ¬„ä½ä¸‹è¼‰ï¼š<strong>æª”æ¡ˆä¸Šå‚³</strong> â†’ ç¨ç«‹æ¬„ä½ å°æ‡‰æ¬„ä½ï¼š æª”æ¡ˆåç¨±</li>
                </li>
                <li>ä½¿ç”¨å•é¡Œè«‹è¯ç¹«ï¼šè³‡è¨Šéƒ¨ ææ²›å‹³</li>
            </ul>
        </div>

        <div class="card p-4">
            <div class="mb-3">
                <label for="zipFileInput" class="form-label">è«‹å°‡ Ragic ä¸‹è¼‰çš„ .zip æª”ä¸Šå‚³ ...</label>
                <input type="file" class="form-control" id="zipFileInput" accept=".zip">
            </div>
            <button class="btn btn-primary w-100" id="convertButton" disabled>é–‹å§‹è½‰æ›</button>
        </div>

        <div id="resultMessage" class="alert mt-3 d-none" role="alert"></div>
    </div>



    <!-- Copyright è²æ˜ -->
    <div class="footer">
        Â© 2025 è¡£çš„è—è¡“æœ‰é™å…¬å¸. All rights reserved.
    </div>

    <script>
        const zipInput = document.getElementById('zipFileInput');
        const convertButton = document.getElementById('convertButton');
        const resultMessage = document.getElementById('resultMessage');

        let zipFile = null;

        zipInput.addEventListener('change', function() {
            zipFile = this.files[0];
            convertButton.disabled = !zipFile;
        });

        convertButton.addEventListener('click', async () => {
            if (!zipFile) return;
            convertButton.disabled = true;
            showResultMessage('æ­£åœ¨è™•ç†ä¸­ï¼Œè«‹ç¨å€™...', 'info');

            try {
                const zip = await JSZip.loadAsync(zipFile);
                const mappingFile = await extractMappingFile(zip);
                if (!mappingFile) {
                    throw new Error('ç„¡æ³•æ‰¾åˆ° mappingFile_ é–‹é ­çš„ .xlsx æª”æ¡ˆ');
                }

                const mapping = await parseMappingFile(mappingFile);
                await renameFiles(zip, mapping);
                const newZipBlob = await zip.generateAsync({ type: 'blob' });

                const today = new Date();
                const formattedDate = today.getFullYear() +
                    String(today.getMonth() + 1).padStart(2, '0') +
                    String(today.getDate()).padStart(2, '0');

                saveAs(newZipBlob, `${formattedDate}_æƒæåˆç´„ç•™å­˜.zip`);
                showResultMessage('æª”æ¡ˆå·²æˆåŠŸé‡å‘½åä¸¦æä¾›ä¸‹è¼‰', 'success');
            } catch (error) {
                showResultMessage(`ç™¼ç”ŸéŒ¯èª¤ï¼š${error.message}`, 'danger');
            } finally {
                convertButton.disabled = false;
            }
        });

        async function extractMappingFile(zip) {
            for (const filename of Object.keys(zip.files)) {
                if (filename.startsWith('mappingFile_') && filename.endsWith('.xlsx')) {
                    return zip.files[filename].async('blob');
                }
            }
            return null;
        }

        async function parseMappingFile(mappingFileBlob) {
            const arrayBuffer = await mappingFileBlob.arrayBuffer();
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const sheet = workbook.Sheets[firstSheetName];
            const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });

            const mapping = {};
            data.slice(1).forEach(row => {
                if (row[0] && row[1]) {
                    const newFileName = row[0].toString().trim();
                    const originalFileNames = row[1].toString().split(',').map(name => name.trim());
                    mapping[newFileName] = originalFileNames;
                }
            });
            return mapping;
        }

        async function renameFiles(zip, mapping) {
            for (const [newFileName, originalFileNames] of Object.entries(mapping)) {
                for (let i = 0; i < originalFileNames.length; i++) {
                    const originalFileName = originalFileNames[i];
                    const file = zip.files[originalFileName];
                    if (file) {
                        const extension = originalFileName.includes('.') ? originalFileName.split('.').pop() : '';
                        const newFileNameWithExt = extension ? `${newFileName}.${extension}` : newFileName;
                        const finalName = originalFileNames.length > 1 
                            ? `${newFileName}-${String(i + 1).padStart(2, '0')}.${extension}`
                            : newFileNameWithExt;
                        
                        zip.file(finalName, await file.async('blob'));
                        zip.remove(originalFileName);
                    }
                }
            }
        }

        function showResultMessage(message, type) {
            resultMessage.textContent = message;
            resultMessage.className = `alert alert-${type} mt-3`;
            resultMessage.classList.remove('d-none');
        }
    </script>
</body>
</html>
